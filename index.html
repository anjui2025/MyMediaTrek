<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyMediaTrek | 觀影清單</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --accent-color: #00d4ff;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --gold-star: #fbbf24;
            --error-color: #ff4757;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 80px;
            overflow-x: hidden;
        }
        /* 背景光暈 */
        .background-blob { position: fixed; border-radius: 50%; filter: blur(80px); z-index: -1; opacity: 0.4; }
        .blob-1 { width: 400px; height: 400px; background: #7000ff; top: -100px; left: -100px; }
        .blob-2 { width: 300px; height: 300px; background: #00d4ff; bottom: 0; right: 0; }
        
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
        }

        /* --- 登入 Modal (最上層) --- */
        #auth-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(10px);
        }
        .auth-box {
            width: 90%; max-width: 400px; padding: 3rem;
            background: var(--bg-dark); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .auth-box h2 { color: var(--accent-color); margin-bottom: 0.5rem; font-size: 2rem; }
        .auth-box p { color: var(--text-muted); margin-bottom: 2rem; font-size: 0.9rem; }
        .auth-box input { 
            width: 100%; padding: 14px; margin-bottom: 1rem; 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            color: white; border-radius: 12px; font-size: 1rem;
        }
        .auth-box button {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--accent-color), #0066ff);
            border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer;
            font-size: 1rem; transition: 0.3s; margin-top: 1rem;
        }
        .auth-box button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3); }

        /* --- 主程式區塊 (預設隱藏，登入後顯示) --- */
        #app-container { display: none; } 

        header { text-align: center; padding: 3rem 1rem 2rem; }
        header h1 {
            font-size: 2.5rem; font-weight: 700;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        header p { color: var(--text-muted); font-size: 1rem; }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        
        .form-card { padding: 2rem; margin-bottom: 3rem; transition: 0.3s; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        
        label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted); }
        input, select, textarea {
            width: 100%; padding: 12px 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; border-radius: 8px; font-size: 1rem; transition: 0.3s;
            appearance: none; font-family: inherit;
        }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-color); background: rgba(0, 0, 0, 0.4); }
        option { background-color: #1e293b; color: white; }
        
        /* 星星評分 */
        .star-rating-selector { display: flex; gap: 5px; font-size: 1.5rem; cursor: pointer; color: rgba(255,255,255,0.2); }
        .star-rating-selector i { transition: 0.2s; }
        .star-rating-selector i:hover, .star-rating-selector i.hovered, .star-rating-selector i.selected { color: var(--gold-star); transform: scale(1.1); }

        .btn-submit {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--accent-color), #0066ff);
            color: white; padding: 12px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.3s; width: 100%;
        }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5); }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }

        /* 列表標頭與分類 */
        .list-header {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; gap: 1rem;
        }
        .section-title { 
            font-size: 1.5rem; font-weight: 600; color: var(--text-main); margin: 0;
            display: flex; align-items: center; gap: 10px; flex-shrink: 0;
        }
        .section-title::before { content: ''; display: block; width: 4px; height: 24px; background: var(--accent-color); border-radius: 2px; }

        .filter-tabs {
            display: flex; gap: 8px; background: rgba(0,0,0,0.2); padding: 5px;
            border-radius: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch;
            max-width: 100%; scrollbar-width: none;
        }
        .filter-tabs::-webkit-scrollbar { display: none; }
        
        .filter-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
            transition: 0.3s; white-space: nowrap; flex-shrink: 0;
        }
        .filter-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .filter-btn.active {
            background: var(--accent-color); color: white; font-weight: 600;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
        }

        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.5rem; }
        .media-card { display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; }
        .media-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.3); }
        .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05); display: flex; justify-content: space-between; align-items: center; }
        .card-type { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .card-body { padding: 1.25rem; flex-grow: 1; }
        .card-title { font-size: 1.25rem; margin-bottom: 0.5rem; font-weight: 600; line-height: 1.4; }
        .card-meta { font-size: 0.85rem; color: var(--text-muted); display: flex; gap: 15px; margin-bottom: 1rem; }
        .card-comment { font-size: 0.9rem; color: #cbd5e1; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-top: 10px; font-style: italic; border-left: 2px solid var(--accent-color); }
        .card-footer { padding: 1rem 1.25rem; background: rgba(0, 0, 0, 0.1); display: flex; justify-content: flex-end; gap: 8px; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; backdrop-filter: blur(5px); }
        .status-To-Watch { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; border: 1px solid rgba(255,255,255,0.1); }
        .status-Watching { background: rgba(0, 212, 255, 0.15); color: #00d4ff; border: 1px solid rgba(0, 212, 255, 0.3); }
        .status-Watched { background: rgba(46, 213, 115, 0.15); color: #2ed573; border: 1px solid rgba(46, 213, 115, 0.3); }
        
        .rating-stars { color: var(--gold-star); font-size: 0.9rem; }
        .btn-icon { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: white; color: black; }
        .btn-delete:hover { background: var(--error-color); color: white; border-color: var(--error-color); }
        
        #toast { visibility: hidden; min-width: 250px; background: rgba(0, 0, 0, 0.8); color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 3000; bottom: 30px; left: 50%; transform: translateX(-50%); font-size: 0.9rem; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 5px 15px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s, bottom 0.3s; width: 90%; max-width: 350px; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 4rem; color: var(--text-muted); border: 2px dashed rgba(255,255,255,0.1); border-radius: 16px; }

        /* 登出按鈕 */
        #logout-btn { 
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; 
            transition: 0.3s; display: none; /* 預設隱藏 */
        }
        #logout-btn:hover { background: var(--error-color); border-color: var(--error-color); }

        @media (max-width: 768px) {
            header { padding: 2rem 1rem; }
            header h1 { font-size: 2rem; }
            .container { padding: 0 16px; }
            .form-card { padding: 1.5rem; margin-bottom: 2rem; }
            .form-grid { grid-template-columns: 1fr; gap: 1rem; }
            .form-group[style*="span 2"] { grid-column: span 1 !important; }
            .list-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .filter-tabs { width: 100%; padding-bottom: 8px; }
            .search-container { margin-bottom: 1.5rem; }
            .media-grid { grid-template-columns: 1fr; gap: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="background-blob blob-1"></div>
    <div class="background-blob blob-2"></div>

    <!-- 1. 登入 Modal (最優先顯示) -->
    <div id="auth-modal">
        <div class="auth-box">
            <h2>Welcome Back</h2>
            <p>請輸入帳號密碼以存取您的片單</p>
            <input type="text" id="login-username" placeholder="帳號 Username">
            <input type="password" id="login-password" placeholder="密碼 Password">
            <button onclick="handleLogin()">登入 Login</button>
            <p style="margin-top: 15px; font-size: 0.8rem; color: #666;">
                * 註冊請聯繫管理員
            </p>
        </div>
    </div>

    <!-- 2. 主程式區塊 (登入成功後顯示) -->
    <div id="app-container">
        <button id="logout-btn" onclick="handleLogout()"><i class="fa-solid fa-right-from-bracket"></i> 登出</button>

        <header>
            <h1>MyMediaTrek</h1>
            <p>你的個人觀影航道</p>
        </header>

        <div class="container">
            <div class="glass-panel form-card">
                <form id="add-media-form">
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: span 2;">
                            <label>標題 Title</label>
                            <input type="text" id="title" placeholder="輸入名稱..." required>
                        </div>
                        <div class="form-group">
                            <label>類型 Type</label>
                            <select id="type" required><option value="Movie">電影 Movie</option><option value="Series">影集 Series</option></select>
                        </div>
                        <div class="form-group">
                            <label>狀態 Status</label>
                            <select id="status" required><option value="To Watch">待看</option><option value="Watching">追劇中</option><option value="Watched">已看完</option></select>
                        </div>
                        <div class="form-group">
                            <label>進度 Progress</label>
                            <input type="text" id="progress" placeholder="如: S01E01">
                        </div>
                        
                        <!-- 互動星星 -->
                        <div class="form-group">
                            <label>評分 Rating</label>
                            <div class="star-rating-selector" id="star-rating-container">
                                <i class="fa-solid fa-star" data-value="1"></i>
                                <i class="fa-solid fa-star" data-value="2"></i>
                                <i class="fa-solid fa-star" data-value="3"></i>
                                <i class="fa-solid fa-star" data-value="4"></i>
                                <i class="fa-solid fa-star" data-value="5"></i>
                            </div>
                            <input type="hidden" id="rating" value="0">
                        </div>

                        <!-- 評論 -->
                        <div class="form-group" style="grid-column: span 2;">
                            <label>心得 Comment</label>
                            <textarea id="comment" rows="3" placeholder="寫點什麼..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn-submit"><i class="fa-solid fa-plus"></i> 加入清單</button>
                    </div>
                </form>
            </div>

            <div class="search-container" style="margin-bottom: 30px;">
                <div class="glass-panel" style="padding: 10px 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fa-solid fa-search" style="color: var(--text-muted);"></i>
                    <input type="text" id="search-input" placeholder="搜尋標題..." style="background: transparent; border: none; color: white; width: 100%; outline: none;">
                </div>
            </div>

            <div class="list-header">
                <h2 class="section-title">我的片單</h2>
                <div class="filter-tabs">
                    <button class="filter-btn active" onclick="filterByStatus('all', this)">全部</button>
                    <button class="filter-btn" onclick="filterByStatus('Watching', this)">追劇中</button>
                    <button class="filter-btn" onclick="filterByStatus('To Watch', this)">待看</button>
                    <button class="filter-btn" onclick="filterByStatus('Watched', this)">已看完</button>
                </div>
            </div>

            <div id="media-grid" class="media-grid"></div>
        </div>
    </div>

    <div id="toast">操作成功</div>

    <script>
        // ⚠️ 記得改成你 Render 的網址 (本地測試用 http://127.0.0.1:5000/api)
        const API_BASE = 'http://127.0.0.1:5000/api'; 
        
        let token = localStorage.getItem('token');
        let allMediaItems = [];
        let currentFilter = 'all';
        let currentEditId = null;

        // 初始化檢查
        checkLoginStatus();

        function checkLoginStatus() {
            if (token) {
                // 已登入：隱藏登入框，顯示主程式
                document.getElementById('auth-modal').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'block';
                loadMediaItems();
            } else {
                // 未登入：顯示登入框，隱藏主程式
                document.getElementById('auth-modal').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'none';
            }
        }

        async function handleLogin() {
            const user = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            const btn = document.querySelector('.auth-box button');
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 登入中...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: user, password: pass})
                });
                const data = await res.json();
                if (res.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    showToast('歡迎回來！');
                    checkLoginStatus();
                } else {
                    showToast('❌ ' + data.msg, 'error');
                }
            } catch (err) { 
                showToast('連線錯誤', 'error'); 
            } finally {
                btn.innerHTML = '登入 Login';
                btn.disabled = false;
            }
        }

        function handleLogout() {
            localStorage.removeItem('token');
            token = null;
            checkLoginStatus();
            showToast('已登出');
        }

        function getHeaders(method = 'GET') {
            const headers = { 'Authorization': `Bearer ${token}` };
            if (method !== 'GET') headers['Content-Type'] = 'application/json';
            return headers;
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.background = type === 'error' ? 'var(--error-color)' : 'rgba(0,0,0,0.8)';
            t.className = 'show';
            setTimeout(() => t.className = '', 3000);
        }

        async function loadMediaItems(query = '') {
            if (!token) return;
            try {
                const url = query ? `${API_BASE}/media?q=${encodeURIComponent(query)}` : `${API_BASE}/media`;
                const res = await fetch(url, { headers: getHeaders() });
                if (res.status === 401) { handleLogout(); return; }
                const json = await res.json();
                if (json.status === 'success') {
                    allMediaItems = json.data;
                    renderCards();
                }
            } catch (err) { console.error(err); }
        }

        document.getElementById('add-media-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('.btn-submit');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';
            submitButton.disabled = true;

            const data = {
                title: document.getElementById('title').value,
                media_type: document.getElementById('type').value,
                status: document.getElementById('status').value,
                progress: document.getElementById('progress').value || null,
                rating: parseInt(document.getElementById('rating').value) || null,
                comment: document.getElementById('comment').value || null
            };

            const method = currentEditId ? 'PUT' : 'POST';
            const url = currentEditId ? `${API_BASE}/media/${currentEditId}` : `${API_BASE}/media`;

            try {
                const res = await fetch(url, { method: method, headers: getHeaders(method), body: JSON.stringify(data) });
                const json = await res.json();
                if (res.ok) {
                    showToast(currentEditId ? '更新成功' : '新增成功');
                    resetForm();
                    loadMediaItems();
                } else {
                    const msg = json.message || '操作失敗';
                    showToast(msg.includes('清單裡囉') ? `✋ ${msg}` : `❌ ${msg}`, 'error');
                }
            } catch (err) { showToast('操作失敗', 'error'); } 
            finally {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        async function deleteItem(id) {
            if (!confirm('確定刪除？')) return;
            try {
                const res = await fetch(`${API_BASE}/media/${id}`, { method: 'DELETE', headers: getHeaders('DELETE') });
                if (res.ok) { showToast('刪除成功'); loadMediaItems(); }
            } catch (err) { showToast('刪除失敗', 'error'); }
        }

        function renderCards() {
            const grid = document.getElementById('media-grid');
            grid.innerHTML = '';
            
            let items = allMediaItems;
            if (currentFilter !== 'all') items = items.filter(i => i.status === currentFilter);

            if (items.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:3rem;color:#888;">這裡還沒有東西...</div>';
                return;
            }

            items.forEach(item => {
                const itemJson = JSON.stringify(item).replace(/"/g, '&quot;');
                const stars = item.rating ? Array(item.rating).fill('<i class="fa-solid fa-star"></i>').join('') + Array(5 - item.rating).fill('<i class="fa-regular fa-star"></i>').join('') : '<span style="color:#888;">無評分</span>';
                const div = document.createElement('div');
                div.className = 'media-card glass-panel';
                div.innerHTML = `
                    <div class="card-header">
                        <span class="card-type">${item.media_type}</span>
                        <span class="badge status-${item.status.replace(' ', '-')}">${item.status}</span>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">${item.title}</h3>
                        <div class="card-meta">
                            <span>${item.current_progress ? '<i class="fa-solid fa-bars-progress"></i> '+item.current_progress : ''}</span>
                        </div>
                        <div class="rating-stars" style="color:var(--gold-star)">${stars}</div>
                        ${item.comment ? `<div class="card-comment">${item.comment}</div>` : ''}
                    </div>
                    <div class="card-footer">
                        <button class="btn-icon" onclick="startEdit(${itemJson})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-icon btn-delete" onclick="deleteItem('${item.media_id}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function startEdit(item) {
            currentEditId = item.media_id;
            document.getElementById('title').value = item.title;
            document.getElementById('type').value = item.media_type;
            document.getElementById('status').value = item.status;
            document.getElementById('progress').value = item.current_progress || '';
            document.getElementById('comment').value = item.comment || '';
            document.getElementById('rating').value = item.rating || 0;
            updateStars(item.rating || 0);
            
            const btn = document.querySelector('.btn-submit');
            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> 更新資料';
            btn.style.background = '#f39c12';
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function resetForm() {
            document.getElementById('add-media-form').reset();
            currentEditId = null;
            updateStars(0);
            const btn = document.querySelector('.btn-submit');
            btn.innerHTML = '<i class="fa-solid fa-plus"></i> 加入清單';
            btn.style.background = '';
        }

        document.getElementById('search-input').addEventListener('input', (e) => loadMediaItems(e.target.value));
        
        window.filterByStatus = function(status, btn) {
            currentFilter = status;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCards();
        }

        const stars = document.querySelectorAll('.star-rating-selector i');
        const ratingInp = document.getElementById('rating');
        
        function updateStars(val) {
            stars.forEach(s => {
                if (s.dataset.value <= val) s.classList.add('selected');
                else s.classList.remove('selected');
            });
        }

        stars.forEach(s => {
            s.addEventListener('click', () => {
                ratingInp.value = s.dataset.value;
                updateStars(s.dataset.value);
            });
        });
    </script>
</body>
</html>